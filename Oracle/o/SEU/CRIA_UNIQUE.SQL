SET SERVEROUTPUT ON SIZE 50000

DECLARE

STR VARCHAR2(1000);

CURSOR C1 IS SELECT TABLE_NAME FROM DBA_TABLES A WHERE OWNER='SEU' AND TABLE_NAME NOT LIKE '%LOG%'
AND TABLE_NAME NOT LIKE '%BKP%' AND TABLE_NAME NOT LIKE '%TESTE%' AND NOT EXISTS 
(SELECT 'X' FROM DBA_CONS_COLUMNS B, DBA_CONSTRAINTS C WHERE A.OWNER=B.OWNER AND A.TABLE_NAME=B.TABLE_NAME
AND B.CONSTRAINT_NAME=C.CONSTRAINT_NAME AND B.TABLE_NAME=C.TABLE_NAME AND B.COLUMN_NAME LIKE '%NREG'
AND C.CONSTRAINT_TYPE='U');

seq number;

BEGIN

	FOR RC1 IN C1 LOOP
	 select nvl(max(to_number(substr(constraint_name,instr(constraint_name,'_',1,2)+2,1))),0) + 1 into seq from dba_constraints where
   table_name=rc1.table_name and constraint_type='U' and owner='SEU';
		BEGIN
			STR := 'ALTER TABLE SEU.'||RC1.TABLE_NAME||' ADD CONSTRAINT UN_'||RC1.TABLE_NAME||'_0'||seq||' UNIQUE '||
					 	 ' (S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_NREG) USING INDEX TABLESPACE SEUX';
			--EXECUTE IMMEDIATE STR;
			DBMS_OUTPUT.PUT_LINE(STR);
		EXCEPTION WHEN OTHERS THEN
			DBMS_OUTPUT.PUT_LINE(RC1.TABLE_NAME||' '||SQLERRM);
		END;
	END LOOP;
END;
