CREATE OR REPLACE PROCEDURE SEU.P_ALTERA_LOG (TABELA IN VARCHAR2)
IS

STR VARCHAR2(4000);
STR1 VARCHAR2(4000);
STR2 VARCHAR2(4000);
COL_ID NUMBER;
POSICAO NUMBER :=0 ;
TAM NUMBER := 0;

CURSOR C1 IS SELECT TABLE_NAME FROM USER_TABLES WHERE TABLE_NAME NOT LIKE '%LOG%' 
																								AND TABLE_NAME LIKE 'SEU%' AND TABLE_NAME NOT LIKE '%TMP%' and table_name=upper(TABELA);

CURSOR C2(TABELA IN VARCHAR2) IS SELECT DISTINCT COLUMN_ID,COLUMN_NAME, DATA_TYPE, DATA_LENGTH FROM USER_TAB_COLUMNS A
																 WHERE TABLE_NAME=TABELA AND DATA_TYPE<>'BLOB' AND COLUMN_NAME NOT LIKE '%NREG%' 
																 AND COLUMN_NAME NOT LIKE '%IDUSUARIO%' 
																 AND NOT EXISTS (SELECT 'X' FROM USER_TAB_COLUMNS B 
																 WHERE B.TABLE_NAME=A.TABLE_NAME||'_LOG' AND (B.COLUMN_NAME=A.COLUMN_NAME||'_ANTES' OR
																 																						B.COLUMN_NAME=A.COLUMN_NAME||'_DEPOIS'))
																 ORDER BY COLUMN_ID;
																 
CURSOR C3(TABELA IN VARCHAR2) IS SELECT DISTINCT A.COLUMN_NAME COLUMN_NAME, A.DATA_TYPE DATA_TYPE, A.DATA_LENGTH DATA_LENGTH
																 FROM USER_TAB_COLUMNS A, USER_TAB_COLUMNS B
																 WHERE A.COLUMN_NAME NOT LIKE '%IDUSUARIO%' AND A.DATA_TYPE<>'BLOB' 
																 AND A.COLUMN_NAME NOT LIKE '%NREG%' AND B.TABLE_NAME=A.TABLE_NAME||'_LOG'
																 AND (B.COLUMN_NAME = A.COLUMN_NAME||'_ANTES' OR B.COLUMN_NAME=A.COLUMN_NAME||'_DEPOIS')
																 AND (A.DATA_TYPE <> B.DATA_TYPE OR A.DATA_LENGTH <> B.DATA_LENGTH)
																 AND A.TABLE_NAME=TABELA;

CURSOR C4(TABELA IN VARCHAR2) IS SELECT COLUMN_ID,COLUMN_NAME, DATA_TYPE FROM USER_TAB_COLUMNS
																	WHERE TABLE_NAME=TABELA 
																	AND DATA_TYPE<>'BLOB' 
																	AND COLUMN_NAME NOT LIKE '%NREG%' 
																  AND COLUMN_NAME NOT LIKE '%IDUSUARIO%' 
																  ORDER BY COLUMN_ID;

BEGIN

	FOR RC1 IN C1 LOOP
	  --TABELA := RC1.TABLE_NAME;
		FOR RC2 IN C2(RC1.TABLE_NAME) LOOP
		  STR := 'ALTER TABLE SEU.'||RC1.TABLE_NAME||'_LOG ADD ('||chr(10);
			IF RC2.DATA_TYPE='VARCHAR2' OR RC2.DATA_TYPE='CHAR' THEN
				STR := STR||RC2.COLUMN_NAME||'_ANTES '||RC2.DATA_TYPE||'('||RC2.DATA_LENGTH||'), '||chr(10)||
				       RC2.COLUMN_NAME||'_DEPOIS '||RC2.DATA_TYPE||'('||RC2.DATA_LENGTH||')'||chr(10);
			ELSE
				STR := STR||RC2.COLUMN_NAME||'_ANTES '||RC2.DATA_TYPE||','||chr(10)||
				       RC2.COLUMN_NAME||'_DEPOIS '||RC2.DATA_TYPE||chr(10);
			END IF;
			STR := STR||')';
			BEGIN
				EXECUTE IMMEDIATE STR;
				DBMS_OUTPUT.PUT_LINE(STR);
			EXCEPTION WHEN OTHERS THEN
				RAISE_APPLICATION_ERROR(-20999,'Erro na tabela '||rc1.table_name||' '||SQLERRM);
			END;
		END LOOP;
		FOR RC3 IN C3(RC1.TABLE_NAME) LOOP
		  STR := 'ALTER TABLE SEU.'||RC1.TABLE_NAME||'_LOG MODIFY ('||chr(10);
			IF RC3.DATA_TYPE='VARCHAR2' OR RC3.DATA_TYPE='CHAR' THEN
				STR := STR||RC3.COLUMN_NAME||'_ANTES '||RC3.DATA_TYPE||'('||RC3.DATA_LENGTH||'), '||chr(10)||
				       RC3.COLUMN_NAME||'_DEPOIS '||RC3.DATA_TYPE||'('||RC3.DATA_LENGTH||')'||chr(10);
			ELSE
				STR := STR||RC3.COLUMN_NAME||'_ANTES '||RC3.DATA_TYPE||','||chr(10)||
				       RC3.COLUMN_NAME||'_DEPOIS '||RC3.DATA_TYPE||chr(10);
			END IF;
			STR := STR||')';
			BEGIN
				EXECUTE IMMEDIATE STR;
				DBMS_OUTPUT.PUT_LINE(STR);
			EXCEPTION WHEN OTHERS THEN
				RAISE_APPLICATION_ERROR(-20999,'Erro na tabela '||rc1.table_name||' '||SQLERRM);
			END;
		END LOOP;
		STR := 'CREATE OR REPLACE TRIGGER SEU.TRG_'||RC1.TABLE_NAME||'_AUDIT_T BEFORE'||CHR(10)
					 ||'INSERT OR UPDATE OR DELETE ON SEU.'||RC1.TABLE_NAME||' REFERENCING OLD AS OLD NEW AS NEW FOR EACH ROW '||CHR(10)
					 ||'DECLARE'||CHR(10)
					 ||'TIPO CHAR(1);'||CHR(10)
					 ||'NREG INTEGER;'||CHR(10)
					 ||'BEGIN'||CHR(10)
					 ||'IF INSERTING THEN'||CHR(10)
					 ||'   TIPO := '||''''||'I'||''''||';'||CHR(10)
					 ||'   NREG := :NEW.S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_NREG;'||CHR(10)
					 ||'END IF;'||CHR(10)
					 ||'IF UPDATING THEN'||CHR(10)
					 ||'   TIPO := '||''''||'U'||''''||';'||CHR(10)
					 ||'   NREG := :OLD.S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_NREG;'||CHR(10)
					 ||'END IF;'||CHR(10)
					 ||'IF DELETING THEN'||CHR(10)
					 ||'   TIPO := '||''''||'D'||''''||';'||CHR(10)
					 ||'   NREG := :OLD.S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_NREG;'||CHR(10)
					 ||'END IF;'||CHR(10)
					 ||'INSERT INTO '||RC1.TABLE_NAME||'_LOG (S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_NREG,OPERACAO,DATA_HORA,IDUSUARIO,ORIGEM' ;
		FOR RC4 IN C4(RC1.TABLE_NAME) LOOP
			STR := STR||','||RC4.COLUMN_NAME||'_ANTES, '||RC4.COLUMN_NAME||'_DEPOIS'||CHR(10);
		END LOOP;
		STR := STR||') VALUES (NREG, TIPO, SYSDATE, NVL(SYS_CONTEXT('||''''||'ctx_idusuario'||''''||','||''''||'idusuario'||''''||'),'||
		      'SYS_CONTEXT('||''''||'USERENV'||''''||','||''''||'SESSION_USER'||''''||')),'||CHR(10)||
		      'NVL(SYS_CONTEXT('||''''||'ctx_idusuario'||''''||','||''''||'origem'||''''||'),'||
		      'SYS_CONTEXT('||''''||'USERENV'||''''||','||''''||'TERMINAL'||''''||'))'||CHR(10);
			SELECT LENGTH(STR) INTO TAM FROM DUAL;
	  	DBMS_OUTPUT.PUT_LINE(TAM);
		FOR RC4 IN C4(RC1.TABLE_NAME) LOOP
			STR := STR||', :OLD.'||RC4.COLUMN_NAME||', :NEW.'||RC4.COLUMN_NAME||CHR(10);
		END LOOP;
		STR := STR||');'||CHR(10);
		STR := STR||'END;';
		BEGIN
	  	--EXECUTE IMMEDIATE STR;
	  		SELECT LENGTH(STR) INTO TAM FROM DUAL;
	  	DBMS_OUTPUT.PUT_LINE(TAM);
	  EXCEPTION WHEN OTHERS THEN
	  	RAISE_APPLICATION_ERROR(-20999,'Erro ao criar trigger de log da tabela '||rc1.table_name||' '||SQLERRM);
	  END;
	END LOOP;
	P_UTL_RECOMP;
END;
/