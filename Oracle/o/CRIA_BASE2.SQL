SET VER OFF
SET ECHO OFF
SET PAGES 0
set serveroutput on size 50000
set lines 200

SPOOL CRIA_USUARIO.SQL
SELECT 'CREATE USER '||USERNAME||' IDENTIFIED BY VALUES '||
''''||PASSWORD||''''||' PROFILE '||PROFILE||' DEFAULT TABLESPACE '||DEFAULT_TABLESPACE||' TEMPORARY TABLESPACE '||
TEMPORARY_TABLESPACE||';'
FROM DBA_USERS A WHERE NOT EXISTS (SELECT 'X' FROM DBA_USERS@DBITJ1P B
WHERE B.USERNAME=A.USERNAME)
/
SPOOL OFF

SPOOL CRIA_ROLE.SQL
SELECT 'CREATE ROLE '||ROLE||';' FROM DBA_ROLES A
WHERE NOT EXISTS (SELECT 'X' FROM DBA_ROLES@DBITJ1P B WHERE B.ROLE=A.ROLE)
/
SPOOL OFF

SPOOL GRANT_ROLE.SQL
SELECT 'GRANT '||GRANTED_ROLE||' TO '||GRANTEE||';'
FROM DBA_ROLE_PRIVS WHERE GRANTEE IN (SELECT USERNAME FROM DBA_USERS A 
WHERE NOT EXISTS (SELECT 'X' FROM DBA_USERS@DBITJ1P B
WHERE B.USERNAME=A.USERNAME))
/
SPOOL OFF

SPOOL GRANT_SYS_PRIVS.SQL
SELECT 'GRANT '||PRIVILEGE||' TO '||GRANTEE||';'
FROM DBA_SYS_PRIVS WHERE GRANTEE IN (SELECT USERNAME FROM DBA_USERS A 
WHERE NOT EXISTS (SELECT 'X' FROM DBA_USERS@DBITJ1P B
WHERE B.USERNAME=A.USERNAME))
/
SPOOL OFF

SPOOL CRIA_DB_LINK.SQL
SELECT 'CREATE PUBLIC DATABASE LINK '||A.DB_LINK||' CONNECT TO '||A.USERNAME||
' IDENTIFIED BY '||B.PASSWORD||' USING '||''''||A.HOST||''''||';'
FROM DBA_DB_LINKS A, SYS.LINK$ B
WHERE A.DB_LINK = B.NAME
AND NOT EXISTS (SELECT 'X' FROM DBA_DB_LINKS@DBITJ1P C 
WHERE C.OWNER=A.OWNER AND C.DB_LINK=A.DB_LINK)
/
SPOOL OFF

SPOOL CRIA_TABLESPACE.SQL
DECLARE

CURSOR C1 IS SELECT TABLESPACE_NAME, INITIAL_EXTENT, NEXT_EXTENT, MAX_EXTENTS
								FROM DBA_TABLESPACES A WHERE NOT EXISTS (SELECT 'X' FROM DBA_TABLESPACES@DBITJ1P B
								WHERE B.TABLESPACE_NAME=A.TABLESPACE_NAME);

CURSOR C2 (TABLESPACE IN VARCHAR2) IS SELECT FILE_NAME, BYTES FROM DBA_DATA_FILES
																			   WHERE TABLESPACE_NAME=TABLESPACE;
FILE DBA_DATA_FILES.FILE_NAME%TYPE;
BYTES DBA_DATA_FILES.BYTES%TYPE;
													   
BEGIN
	
	FOR RC1 IN C1 LOOP
		DBMS_OUTPUT.PUT_LINE(CHR(10)||CHR(10)||'CREATE TABLESPACE '||RC1.TABLESPACE_NAME||' DATAFILE ');
		OPEN C2(RC1.TABLESPACE_NAME);
		FETCH C2 INTO FILE, BYTES;
		DBMS_OUTPUT.PUT_LINE(''''||'E:\ITJA\ADMIN\DBF\'||UPPER(SUBSTR(FILE,10,LENGTH(FILE)))||''''||' SIZE '||BYTES||' REUSE');
		LOOP
		  FETCH C2 INTO FILE, BYTES;
		  EXIT WHEN C2%NOTFOUND;
			DBMS_OUTPUT.PUT_LINE(','||''''||'E:\ITJA\ADMIN\DBF\'||UPPER(SUBSTR(FILE,10,LENGTH(FILE)))||''''||' SIZE '||BYTES||' REUSE');
	  END LOOP;
	  CLOSE C2;
	  DBMS_OUTPUT.PUT_LINE('DEFAULT STORAGE (');
		DBMS_OUTPUT.PUT_LINE('INITIAL '||RC1.INITIAL_EXTENT);
		DBMS_OUTPUT.PUT_LINE('NEXT '||RC1.NEXT_EXTENT);
		DBMS_OUTPUT.PUT_LINE('MAXEXTENTS '||RC1.MAX_EXTENTS||');');
	END LOOP;
END;
/
SPOOL OFF

SPOOL QUOTAS.SQL
SELECT 'ALTER USER '||USERNAME||' QUOTA UNLIMITED ON '||TABLESPACE_NAME||';'
FROM DBA_TS_QUOTAS WHERE TABLESPACE_NAME IN (SELECT 'X' FROM DBA_TABLESPACES A 
								WHERE NOT EXISTS (SELECT 'X' FROM DBA_TABLESPACES@DBITJ1P B
								WHERE B.TABLESPACE_NAME=A.TABLESPACE_NAME))
/
SPOOL OFF

SPOOL CRIA_SYNONYM.SQL
SELECT 'CREATE '||DECODE(OWNER,'PUBLIC','PUBLIC SYNONYM ','SYNONYM '||OWNER||'.')
			 ||'"'||SYNONYM_NAME||'" FOR '||TABLE_OWNER||'."'
			 ||TABLE_NAME||'";'
FROM DBA_SYNONYMS A
WHERE TABLE_OWNER NOT IN ('SYSTEM','SYS','AURORA$JIS$UTILITY$','OSE$HTTP$ADMIN',
'AURORA$ORB$UNAUTHENTICATED','DBSNMP') AND
NOT EXISTS (SELECT 'X' FROM DBA_SYNONYMS@DBITJ1P B WHERE B.OWNER=A.OWNER AND B.SYNONYM_NAME=A.SYNONYM_NAME)
/
SPOOL OFF
