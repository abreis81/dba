SET SERVEROUTPUT ON SIZE 50000

DECLARE

STR VARCHAR2(1000);

CURSOR C1 IS SELECT DISTINCT TABLE_NAME FROM DBA_TAB_COLUMNS WHERE OWNER='SEU' AND TABLE_NAME NOT IN ('SEUAAA','SEUAAD')
AND COLUMN_NAME LIKE '%IDEMPRESA'  AND TABLE_NAME NOT LIKE '%BKP%' AND TABLE_NAME NOT LIKE '%TESTE%'
AND TABLE_NAME NOT LIKE '%LOG%' 
AND TABLE_NAME NOT IN (SELECT TABLE_NAME FROM DBA_CONSTRAINTS WHERE OWNER='SEU'
AND R_CONSTRAINT_NAME='PK_SEUAAA')
AND TABLE_NAME NOT IN (SELECT VIEW_NAME FROM DBA_VIEWS WHERE OWNER='SEU') ;


BEGIN

	FOR RC1 IN C1 LOOP
		BEGIN
			STR := 'ALTER TABLE SEU.'||RC1.TABLE_NAME||' ADD CONSTRAINT FK_'||RC1.TABLE_NAME||'_SEUAAA FOREIGN KEY '||
					 	 ' (S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_IDEMPRESA) REFERENCES SEU.SEUAAA(SAAA_IDEMPRESA)';
			EXECUTE IMMEDIATE STR;
			--DBMS_OUTPUT.PUT_LINE(STR);
		EXCEPTION WHEN OTHERS THEN
			DBMS_OUTPUT.PUT_LINE(RC1.TABLE_NAME||' '||SQLERRM);
		END;
	END LOOP;
END;


DECLARE

STR VARCHAR2(1000);

CURSOR C1 IS SELECT DISTINCT TABLE_NAME FROM DBA_TAB_COLUMNS WHERE OWNER='SEU' AND TABLE_NAME NOT IN ('SEUAAA','SEUAAD')
AND COLUMN_NAME LIKE '%IDEMPRESA'  AND TABLE_NAME NOT LIKE '%BKP%' AND TABLE_NAME NOT LIKE '%TESTE%' 
and TABLE_NAME NOT IN (SELECT TABLE_NAME FROM DBA_CONSTRAINTS WHERE OWNER='SEU'
AND R_CONSTRAINT_NAME='PK_SEUAAD');


BEGIN

	FOR RC1 IN C1 LOOP
		BEGIN
			STR := 'ALTER TABLE SEU.'||RC1.TABLE_NAME||' ADD CONSTRAINT FK_'||RC1.TABLE_NAME||'_SEUAAD FOREIGN KEY '||
					 	 ' (S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_IDUSUARIO,S'||SUBSTR(RC1.TABLE_NAME,4,3)||'_IDEMPRESA) REFERENCES SEU.SEUAAD(SAAD_IDUSUARIO, SAAD_IDEMPRESA)';
			EXECUTE IMMEDIATE STR;
			--DBMS_OUTPUT.PUT_LINE(STR);
		EXCEPTION WHEN OTHERS THEN
			DBMS_OUTPUT.PUT_LINE(RC1.TABLE_NAME||' '||SQLERRM);
		END;
	END LOOP;
END;
